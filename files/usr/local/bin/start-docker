#!/bin/bash

if [ -z "$(whoami | grep root)" ]; then
    echo "Not running as root."
    exit
fi

run_update="0"
if [ "$1" = "update-with-start" ] || [ "$1" = "update-no-start" ]; then
    run_update="1"
fi

run_start="0"
if [ "$1" = "update-with-start" ] || [ "$1" = "" ]; then
    run_start="1"
fi

if [ ! "$(docker ps -f name=lms -q)" ]; then
    if [ "$run_update" = "1" ]; then
        docker pull lmscommunity/lyrionmusicserver:stable
    fi

    if [ "$run_start" = "1" ]; then
        docker run \
            -d \
            --rm \
            --name lms \
            -v "/media/usbdata/rpms/config/docker/lms":"/config":rw \
            -v "/media/usbdata/user/music":"/music":ro \
            -v "/etc/localtime":"/etc/localtime":ro \
            -v "/etc/timezone":"/etc/timezone":ro \
            -p 9000:9000/tcp \
            -p 9090:9090/tcp \
            -p 3483:3483/tcp \
            -p 3483:3483/udp \
            lmscommunity/lyrionmusicserver:stable
    fi
fi

if [ ! "$(docker ps -f name=transmission -q)" ]; then
    if [ "$run_update" = "1" ]; then
        docker pull linuxserver/transmission:latest
    fi

    if [ "$run_start" = "1" ]; then    
        docker run \
            -d \
            --rm \
            --name transmission \
            -p 9091:9091 \
            -e PUID=1000 \
            -e PGID=1000 \
            -v /media/usbdata/rpms/config/docker/transmission:/config \
            -v /media/usbdata/user/downloads:/downloads \
            linuxserver/transmission:latest
    fi
fi

if [ ! "$(docker ps -f name=syncthing -q)" ]; then
    if [ "$run_update" = "1" ]; then
        docker pull lscr.io/linuxserver/syncthing:latest
    fi

    if [ "$run_start" = "1" ]; then
        # Note: parameter hostname is optional
        docker run \
            -d \
            --rm \
            --name syncthing \
            -e PUID=1000 \
            -e PGID=1000 \
            -e TZ=Europe/Amsterdam \
            -p 8384:8384 \
            -p 22000:22000/tcp \
            -p 22000:22000/udp \
            -p 21027:21027/udp \
            -v /media/usbdata/rpms/config/docker/syncthing:/config \
            -v /media/usbdata/user:/data\
            lscr.io/linuxserver/syncthing:latest
    fi
fi

